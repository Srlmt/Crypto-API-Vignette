---
title: "Interacting with Cryptocurrency API"
author: "Joey Chen"
date: "10/5/2021"
---

```{r packages and API, include=FALSE}
library(tidyverse)
library(jsonlite)
library(knitr)
library(lubridate)

APIkey="r87x5acIqxjYxZWZ31xO3dxUjQGVlja6"
```

```{r graphics_crypto, echo=FALSE}
include_graphics(path="images/crypto.jpg")
```

# Introduction

Brief Intro Here...

# Requirements

```{r graphics_packages, echo=FALSE}
include_graphics(path="images/packages.png")
```

### R Packages

The following packages are required to use the API function:

  + `tidyverse`: Useful data tools for transforming and visualizing data
  + `jsonlite`: Interact and download data with API
  + `knitr`: Display well-formatted tables
  + `lubridate`: Useful date functions 

### API Key

You will also need an API key to be able to interact with the API. Please go to [polygon.io](https://polygon.io/) to register for a free API key. You will need to assign the key to the variable `APIkey`, as follows: 

```{r APIkey, eval=FALSE}
APIkey = "insert_key_here"
```

# Functions to Interact with API

5 API Calls / Minute
  
## (1) `getExchange` 

**Description:** Function to get Crypto Exchanges Data

**Input:** None

**Output:** Returns a table of exchange data information

```{r exchange}

getExchange <- function(){
  
   # Build the URL  
   baseURL <- "https://api.polygon.io/v1/meta/crypto-exchanges/"
   key <- paste0("?apiKey=", APIkey)
   URL <- paste0(baseURL, key)
   
   # Use the URL to retrieve data from API
   exchangeData <- fromJSON(URL)
   
   return(exchangeData)
}

# Sample Function Call
kable(getExchange())
```
  
  
## (2) `getNews` 

**Description:** Function to get Bitcoin news. It currently does not work for any other cryptocurrencies.

**Input:** None

**Output:** Returns a table of Bitcoin news such as title, author, and link. 

```{r news, warning=FALSE}

getNews <- function(){
  
   # Build the URL  
   baseURL <- "https://api.polygon.io/v2/reference/news?limit=20&order=descending&sort=published_utc&ticker=BTC"
   key <- paste0("&apiKey=", APIkey)
   URL <- paste0(baseURL, key)
   
   # Use the URL to retrieve data from API
   newsList <- fromJSON(URL)
   newsData <- newsList$results %>% select(publisher, title, author, published_utc, article_url)
   
   return(newsData)
}

# Sample Function Call
kable(head(getNews(), n=3))
```
  
  
## (3) `getDailyMarket` 

**Description:** Function to get the daily grouped data for the entire Crypto market

**Input:** Date in "YYYY-MM-DD" format

**Output:** Returns a table of containing crypto market information for the input date

```{r DailyMarket}
getDailyMarket <- function(date=Sys.Date()){

   # Build the URL
   baseURL <- "https://api.polygon.io/v2/aggs/grouped/locale/global/market/crypto/"
   key <- paste0("?apiKey=", APIkey)
   day <- date
   URL <- paste0(baseURL, day, key)
   
   # Use the URL to retrieve data from API
   rawList <- fromJSON(URL)
   rawData <- rawList$results
   
   marketData <- rawData %>% select(ticker = T, volume = v, priceOpen = o, priceClose = c)
   
   return(marketData)
}

# Sample Function Call
kable(head(getDailyMarket("2021-09-30"), n=5))
```
  
  
## (4) `getTickerDetails` 

**Description:** Function to get more information about the input ticker

**Input:** Ticker name. Examples: "BTCUSD" or "ETHUSD"

**Output:** Returns a table of ticker information such as currency symbol and name

```{r TickerDetails, warning=FALSE}

getTickerDetails <- function(ticker){

   # Build the URL  
   baseURL <- "https://api.polygon.io/vX/reference/tickers/"
   symbol <- paste0("X:", ticker)
   key <- paste0("?apiKey=", APIkey)
   URL <- paste0(baseURL, symbol, key)
   
   # Use the URL to retrieve data from API
   tickerList <- fromJSON(URL)
   tickerData <- as.data.frame(tickerList$results) %>% select(ticker, name, market, locale, currency_name, base_currency_symbol, base_currency_name)
   
   return(tickerData)
}

# Sample Function Call
kable(getTickerDetails("ETHUSD"))
```
  
  
## (5) `getPreviousClose` 

**Description:** Function to get the previous day's open, high, low, and close for the input cryptocurrency

**Input:** Cryptocurrency pair ticker. Example: "BTCUSD" or "ETHUSD"

**Output:** Returns a table of containing previous day's data

```{r PreviousClose}
getPreviousClose <- function(ticker){
      
   baseURL <- "https://api.polygon.io/v2/aggs/ticker/"
   symbol <- paste0("X:", ticker, "/")
   otherSettings <- "prev?adjusted=true"
   key <- paste0("&apiKey=", APIkey)
   URL <- paste0(baseURL, symbol, otherSettings, key)
   
   # Use the URL to retrieve data from API
   prevCloseList <- fromJSON(URL)
   prevCloseData <- prevCloseList$results %>% select(ticker = T, volume = v, priceOpen = o, priceClose = c, priceLowest = l, priceHighest = h)

   return(prevCloseData)   
}

#Sample Function Call
kable(getPreviousClose("ETHUSD"))
```
  
  
## (6) `getAggregates` 

**Description:** Function to get 1-year aggregate data for a cryptocurrency pair ending at a given date

**Input:** Date in "YYYY-MM-DD" format

**Output:** Returns a table of containing crypto market information such as daily volume and price

```{r Aggregates}
getAggregates <- function(date=Sys.Date(), ticker){

   # Retrieve the date 1 year prior to the input date
   dayEnd <- as.Date(date)
   dayStart <- dayEnd - 364
   
   # Build the URL
   baseURL <- "https://api.polygon.io/v2/aggs/ticker/"
   symbol <- paste0("X:", ticker, "/")
   range <- "range/1/day/"
   otherSettings <- "?adjusted=true&sort=asc&limit=365"
   key <- paste0("&apiKey=", APIkey)
   URL <- paste0(baseURL, symbol, range, dayStart, "/", dayEnd, otherSettings, key)
   
   # Use the URL to retrieve data from API
   aggregateList <- fromJSON(URL)
   aggregateData <- aggregateList$results
   
   # Select Variables for the output dataset
   date_range <- as.Date(c(dayStart:dayEnd), origin = "1970-01-01")
   
   # Get the Quarter of the date
   qtr <- paste0(year(date_range), " Q", quarter(date_range))
   
   cryptoData <- data.frame(qtr, date_range, aggregateData$v, aggregateData$o, aggregateData$c)
   colnames(cryptoData) <- c("quarter", "date", "volume", "priceOpen", "priceClose")
   
   return(cryptoData)
}

kable(head(getAggregates("2021-09-30", ticker="BTCUSD"), n=5))
```
  
  
## (7)[Wrapper] `cryptoAPI`

**Description:** Wrapper function to call any of the 6 functions above

**Input:** The `func` parameter can take either the function id (1-6) or the function name (in quotes), Additional parameters needed for the specific function can also be passed in

**Output:** Returns the output from the specific function called

```{r wrapper}
cryptoAPI <- function(func, name="", ticker="", date=Sys.Date()){
   
   if (is.numeric(func)){
      if (!between(func, 1, 6)){
         stop("ERROR: There are only 6 functions. Please input a valid function ID (1 to 6)")
      } else{
        func <- switch(func,
                    "getExchange",
                    "getNews",
                    "getDailyMarket",
                    "getTickerDetails",
                    "getPreviousClose",
                    "getAggregates")
      } 
   }
   
   if (name != "" | ticker != ""){
   
      # Allow user to specify either the crypto currency name or the ticker name
      if (name != ""){
      symbol <- switch(toupper(name),
                       BITCOIN = "BTCUSD",
                       ETHEREUM = "ETHUSD",
                       CARDANO = "ADAUSD",
                       XRP = "XRPUSD",
                       SOLANA = "SOLUSD",
                       POLKADOT = "DOTUSD",
                       DOGECOIN = "DOGEUSD",
                       UNISWAP = "UNIUSD",
                       CHAINLINK = "LINKUSD",
                       LITECOIN = "LTCUSD",
                       )
      } else if (ticker != ""){
        symbol <- toupper(ticker)
      } else{
         stop("ERROR: Please input a valid cryptocurrency name or ticker")
      }
      

      if (symbol == ""){
         message <- paste("ERROR: Only the top 10 cryptocurrencies by market cap are supported,", 
                          "please input another name, or use the `ticker` and input a valid Crypto ticker")
         stop(message)
         
      }else if (!(paste0("X:", symbol) %in% getDailyMarket()$ticker)){
         message <- "ERROR: ticker not supported. Please input a valid ticker"
         
         stop(message)
      }
      
   }else if(name == "" & ticker == "" & func %in% c("getTickerDetails", "getPreviousClose", "getAggregates")){
      stop("ERROR: Missing cryptocurrency name or ticker input required for this function")
   }   
   
   
   # Function 1
   if (func == "getExchange"){
      output <- getExchange()
   
   # Function 2      
   }else if (func == "getNews"){
      output <- getNews()
      
   # Function 3   
   }else if (func == "getDailyMarket"){
      output <- getDailyMarket(date)
   
   # Function 4      
   }else if (func == "getTickerDetails"){
      output <- getTickerDetails(symbol)
   
   # Function 5   
   }else if (func == "getPreviousClose"){
      output <- getPreviousClose(symbol)
   
   # Function 6      
   }else if (func == "getAggregates"){
      output <- getAggregates(date, symbol)
      
   }else{
      stop("ERROR: The `func` argument is not valid")
   }
   
   return(output)
}
```
  
The following are examples of valid functions calls:

```{r valid function calls, eval=FALSE}
cryptoAPI(1)
cryptoAPI("getNews")
cryptoAPI(3)
cryptoAPI("getTickerDetails", name="cardano")
cryptoAPI(5, ticker="ethusd")
cryptoAPI(6, name="eThErEuM")
```

  
# Data Exploration

```{r percent change, include=FALSE}
bitcoinData <- cryptoAPI("getAggregates", name="Bitcoin", date="2021-09-30")

# Calculate percent change
price <- bitcoinData$`Closing Price`


  
plot(x=bitcoinData$date, y= bitcoinData$priceClose)

```
  
  
## Bitcoin Market Behavior

We can examine the Bitcoin trading Volume by looking at the Box plot. 

```{r Boxplot}
ggplot(bitcoinData, aes(quarter, volume)) +
   geom_boxplot(size=1) +
   geom_jitter(aes(y=volume, fill=quarter, color=quarter), size=2) +
   labs(title="Boxplot for Bitcoin Trading Volume by Quarter") +
   theme(text=element_text(size=16), 
         panel.grid.major = element_line(size=1.5),
         axis.ticks = element_line(size=1.4),
         axis.ticks.length = unit(0.20, 'cm'))
```
  
## Bitcoin vs Ethereum

```{r BTC ETH image, echo=FALSE}
include_graphics(path="images/bitcoin_vs_ethereum.jpg")
```

Ethereum, the second largest cryptocurrency by market cap, is often compared to Bitcoin. As of 2021-10-02, Bitcoin has a market cap of \$900 million, while Ethereum has a market cap of \$400 million. We can  first look at the performance of the two cryptocurrencies over the past year. 

```{r BTC ETH performance}
ethereumData <- cryptoAPI(6, name="Ethereum", date="2021-09-30")

calcPerformance <- function(price){

   change1Day <- scales::percent((price[365] - price[364]) / price[364], accuracy=0.1)
   change7Day <- scales::percent((price[365] - price[358]) / price[358], accuracy=0.1)
   change30Day <-scales::percent((price[365] - price[335]) / price[335], accuracy=0.1)
   changeYear <- scales::percent((price[365] - price[1]) / price[1], accuracy=0.1)
   
   scales::label_percent(c(change1Day, change7Day))
   
   performanceData <- cbind(price = price[365], '24h %' = change1Day, '7d %' = change7Day, '30d %' = change30Day, 'yr %' = changeYear)
   
   return(performanceData)
}

bitcoinPerformance <- cbind(cryptocurrency = "Bitcoin", calcPerformance(bitcoinData$priceClose))
ethereumPerformance <- cbind(cryptocurrency = "Ethereum", calcPerformance(ethereumData$priceClose))

kable(rbind(bitcoinPerformance, ethereumPerformance))

```
```{r BTC ETH scatterplot}
plot(x=bitcoinData$priceClose, y=ethereumData$priceClose)
```

# Conclusion



